/**
 * Excel Template Generator
 * 학생 Import용 엑셀 템플릿 생성
 */

import * as XLSX from 'xlsx'

/**
 * 학생 Import 템플릿 생성 및 다운로드
 */
export function downloadStudentImportTemplate() {
  // 워크북 생성
  const workbook = XLSX.utils.book_new()

  // 헤더 정의
  const headers = [
    '학생 이름*',
    '생년월일(YYYY-MM-DD)*',
    '학년',
    '학교',
    '학생 연락처',
    '학생 이메일',
    '메모',
    '보호자1 이름*',
    '보호자1 연락처',
    '보호자1 이메일',
    '보호자1 관계',
    '보호자1 직업',
    '보호자1 주소',
    '보호자2 이름',
    '보호자2 연락처',
    '보호자2 이메일',
    '보호자2 관계',
    '보호자2 직업',
    '보호자2 주소',
  ]

  // 가이드 행
  const guideRow = [
    '예) 홍길동',
    '예) 2010-05-15',
    '예) 중1',
    '예) 충무중학교',
    '예) 010-1234-5678',
    '예) student@email.com',
    '선택 입력',
    '예) 홍아버지',
    '예) 010-9876-5432',
    '예) parent@email.com',
    '예) 부, 모, 조부, 조모',
    '예) 회사원',
    '예) 서울시 강남구',
    '예) 홍어머니',
    '예) 010-8888-9999',
    '예) parent2@email.com',
    '예) 모',
    '예) 주부',
    '예) 서울시 강남구',
  ]

  // 예시 데이터 (2개 행)
  const exampleData = [
    [
      '김철수',
      '2010-03-15',
      '중1',
      '서울중학교',
      '010-1111-2222',
      'student1@email.com',
      '우수 학생',
      '김아버지',
      '010-3333-4444',
      'father@email.com',
      '부',
      '회사원',
      '서울시 강남구',
      '김어머니',
      '010-5555-6666',
      'mother@email.com',
      '모',
      '주부',
      '서울시 강남구',
    ],
    [
      '이영희',
      '2011-07-20',
      '중2',
      '강남중학교',
      '010-2222-3333',
      '',
      '',
      '이어머니',
      '010-7777-8888',
      'lee.mom@email.com',
      '모',
      '간호사',
      '서울시 서초구',
      '',
      '',
      '',
      '',
      '',
      '',
    ],
  ]

  // 데이터 시트 생성
  const wsData = [headers, guideRow, ...exampleData]
  const worksheet = XLSX.utils.aoa_to_sheet(wsData)

  // 열 너비 설정
  const colWidths = [
    { wch: 12 }, // 학생 이름
    { wch: 20 }, // 생년월일
    { wch: 10 }, // 학년
    { wch: 15 }, // 학교
    { wch: 15 }, // 학생 연락처
    { wch: 20 }, // 학생 이메일
    { wch: 20 }, // 메모
    { wch: 12 }, // 보호자1 이름
    { wch: 15 }, // 보호자1 연락처
    { wch: 20 }, // 보호자1 이메일
    { wch: 15 }, // 보호자1 관계
    { wch: 15 }, // 보호자1 직업
    { wch: 20 }, // 보호자1 주소
    { wch: 12 }, // 보호자2 이름
    { wch: 15 }, // 보호자2 연락처
    { wch: 20 }, // 보호자2 이메일
    { wch: 15 }, // 보호자2 관계
    { wch: 15 }, // 보호자2 직업
    { wch: 20 }, // 보호자2 주소
  ]
  worksheet['!cols'] = colWidths

  // 시트 추가
  XLSX.utils.book_append_sheet(workbook, worksheet, '학생 정보 입력')

  // 가이드 시트 생성
  const guideSheet = createGuideSheet()
  XLSX.utils.book_append_sheet(workbook, guideSheet, '입력 가이드')

  // 파일 다운로드
  const fileName = `학생_일괄등록_템플릿_${new Date().toISOString().split('T')[0]}.xlsx`
  XLSX.writeFile(workbook, fileName)
}

/**
 * 가이드 시트 생성
 */
function createGuideSheet() {
  const guideData = [
    ['학생 일괄 등록 가이드'],
    [''],
    ['1. 필수 항목'],
    ['  - 학생 이름: 반드시 입력해야 합니다.'],
    ['  - 생년월일: YYYY-MM-DD 형식으로 입력해야 합니다. (예: 2010-05-15)'],
    ['  - 보호자1 이름: 최소 1명의 보호자 이름은 필수입니다.'],
    [''],
    ['2. 선택 항목'],
    ['  - 학년: 예) 중1, 중2, 고1 등'],
    ['  - 학교: 학교 이름을 입력합니다.'],
    ['  - 학생 연락처: 학생의 휴대폰 번호'],
    ['  - 학생 이메일: 학생의 이메일 주소'],
    ['  - 메모: 추가로 기록할 내용'],
    [''],
    ['3. 보호자 정보'],
    ['  - 보호자1은 필수, 보호자2는 선택입니다.'],
    ['  - 이름: 보호자 성함을 입력합니다.'],
    ['  - 연락처: 보호자 휴대폰 번호'],
    ['  - 이메일: 보호자 이메일 주소'],
    ['  - 관계: 부, 모, 조부, 조모, 외조부, 외조모, 삼촌, 이모, 고모 등'],
    ['  - 직업: 보호자 직업'],
    ['  - 주소: 보호자 주소'],
    [''],
    ['4. 중복 처리'],
    ['  - 동일한 이름과 생년월일을 가진 학생이 이미 있는 경우,'],
    ['    미리보기 단계에서 중복으로 표시됩니다.'],
    ['  - 중복 처리 방식을 선택할 수 있습니다:'],
    ['    • 건너뛰기: 기존 학생 정보를 유지합니다.'],
    ['    • 덮어쓰기: 엑셀 파일의 정보로 기존 정보를 업데이트합니다.'],
    [''],
    ['5. 주의사항'],
    ['  - 헤더 행(첫 번째 줄)은 수정하지 마세요.'],
    ['  - 가이드 행(두 번째 줄)은 삭제하고 데이터를 입력하세요.'],
    ['  - 날짜는 반드시 YYYY-MM-DD 형식이어야 합니다.'],
    ['  - 빈 행이 있으면 자동으로 건너뜁니다.'],
    ['  - 최대 1000명까지 한 번에 등록할 수 있습니다.'],
    [''],
    ['6. 진행 절차'],
    ['  1) 템플릿 다운로드'],
    ['  2) 엑셀 파일 작성'],
    ['  3) 파일 업로드'],
    ['  4) 미리보기 확인 (신규/중복/오류 분류)'],
    ['  5) 중복 처리 방식 선택'],
    ['  6) 최종 확인 및 가져오기'],
  ]

  const worksheet = XLSX.utils.aoa_to_sheet(guideData)

  // 첫 번째 열 너비 설정
  worksheet['!cols'] = [{ wch: 80 }]

  return worksheet
}
