# Supabase Rate Limit 분석 및 대응 전략

## 현재 설정 (Supabase Free Tier)

| 항목 | 제한 | 시간 단위 | 대상 |
|-----|------|---------|-----|
| **이메일 전송** | 30 | 시간당 | 프로젝트 전체 |
| **SMS 전송** | 150 | 시간당 | 프로젝트 전체 |
| **토큰 갱신** | 30 | 5분당 | IP 주소별 |
| **OTP/Magic Link 검증** | 30 | 5분당 | IP 주소별 |
| **익명 로그인** | 30 | 시간당 | IP 주소별 |
| **회원가입/로그인** | 30 | 5분당 | IP 주소별 |

> **시간당 환산**: 회원가입/로그인은 5분당 30회 → **시간당 최대 360회**

## 위험 시나리오 분석

### 🚨 높은 위험: 이메일 전송 (30/시간)

**시나리오 1: 학원 오리엔테이션**
```
상황: 새 학기 시작, 학생 30명이 동시 회원가입
결과: ✅ 간신히 통과 (30/30)
```

**시나리오 2: 학생들의 이메일 재전송**
```
상황: 20명 회원가입 + 10명이 "인증 이메일 다시 받기" 클릭
결과: ❌ Rate Limit 초과 (40/30)
에러: "Email rate limit exceeded"
```

**시나리오 3: 여러 학원 동시 운영**
```
상황: 학원 A(15명) + 학원 B(20명) 동시 가입
결과: ❌ Rate Limit 초과 (35/30)
```

**영향**:
- 사용자는 "회원가입이 실패했다"고 생각
- 고객 만족도 저하
- 고객 지원 요청 증가

### ⚠️ 중간 위험: 회원가입/로그인 (30/5분 per IP)

**시나리오 1: 학원 WiFi 환경**
```
상황: 학원에서 10명의 학생이 같은 WiFi로 동시 가입
문제: NAT로 인해 모두 같은 Public IP 사용
결과: ❌ IP당 제한 도달 (10명 중 일부만 성공)
```

**시나리오 2: 회사/아파트 네트워크**
```
상황: 같은 건물 내 여러 사용자가 동시 접속
결과: ⚠️ 일부 사용자 접속 차단
```

**영향**:
- 학원 현장에서 단체 가입 시 문제
- "이미 누군가 사용 중" 오해
- 대체 네트워크 필요 (모바일 데이터 전환)

### ✅ 낮은 위험: 토큰 갱신 (30/5분 per IP)

정상적인 사용 패턴에서는 문제 없음.

### ✅ 낮은 위험: OTP/Magic Link 검증 (30/5분 per IP)

정상적인 사용 패턴에서는 문제 없음.

## 대응 전략

### 1단계: 코드 레벨 Rate Limiting (즉시 적용)

#### A. 이메일 재전송 제한

**구현**:
- 사용자별 1분에 1회만 재전송 가능
- 버튼 비활성화 + 카운트다운 타이머

**효과**:
- Supabase 이메일 할당량 보호
- 무분별한 재전송 방지
- 시간당 30회 → 10-15회로 감소 예상

#### B. 친절한 Rate Limit 에러 메시지

**기존**:
```
"Email rate limit exceeded"
```

**개선**:
```
"현재 많은 사용자가 동시에 가입하고 있습니다.
잠시 후(1-2분) 다시 시도해주세요."
```

### 2단계: Supabase 설정 조정 (프로덕션 배포 전)

#### 권장 설정 (Pro tier 기준)

| 항목 | Free Tier | 권장 설정 | 이유 |
|-----|----------|---------|-----|
| **이메일 전송** | 30/시간 | **100/시간** | 학원 3-4개 동시 운영 가능 |
| **회원가입/로그인** | 30/5분 | **50/5분** | 학원 WiFi 환경 대응 |
| **토큰 갱신** | 30/5분 | 30/5분 (유지) | 충분함 |

#### Supabase Pro Tier 비용 분석

**Pro Tier**: $25/월
- 이메일: 100/시간 (기본) → 추가 구매 가능
- 더 높은 Rate Limit
- 우선 지원

**비용 대비 효과**:
```
학원 1개당 월 사용료: $50-100 (예상)
Supabase Pro 비용: $25/월
→ 학원 1개만 운영해도 충분히 회수 가능
```

### 3단계: 모니터링 및 알림

#### A. Rate Limit 도달 감지

**구현**:
```typescript
// Sentry/Logflare 로그
if (error.message.includes('rate limit')) {
  captureException('Rate Limit Exceeded', {
    type: 'email',
    tenant_id: user.tenant_id,
    timestamp: new Date(),
  })
}
```

**효과**:
- 실시간 Rate Limit 문제 감지
- 특정 학원/시간대 패턴 파악
- 사전 대응 가능

#### B. 대시보드 메트릭

**추적 지표**:
- 시간당 이메일 전송 횟수
- IP당 요청 횟수
- Rate Limit 에러 발생 빈도

### 4단계: 비즈니스 로직 최적화

#### A. 이메일 전송 최적화

**현재**:
```
회원가입 → 인증 이메일 발송
재전송 클릭 → 인증 이메일 발송
```

**최적화**:
```
회원가입 → 인증 이메일 발송
재전송 클릭 → [1분 대기] → 인증 이메일 발송
자동 재시도 → [지수 백오프] → 인증 이메일 발송
```

#### B. 배치 처리 고려

**시나리오**: 학원에서 학생 30명 대량 등록

**Option 1**: 순차 처리
```
학생 1 → 이메일 발송 (즉시)
학생 2 → 이메일 발송 (2초 대기)
학생 3 → 이메일 발송 (4초 대기)
...
→ 전체 완료: 약 1-2분
```

**Option 2**: 대기열 시스템
```
학생 30명 등록 → Queue에 추가
백그라운드 Worker → 1분에 5명씩 처리
→ 전체 완료: 약 6분
```

## 프로덕션 체크리스트

### 출시 전 필수 작업

- [ ] **코드 레벨 Rate Limiting 구현** (1-2시간)
  - [ ] 이메일 재전송 1분 제한
  - [ ] Rate Limit 에러 메시지 개선
  - [ ] 버튼 비활성화 + 타이머

- [ ] **Supabase Pro Tier 업그레이드** ($25/월)
  - [ ] 이메일 100/시간 설정
  - [ ] 회원가입/로그인 50/5분 설정

- [ ] **모니터링 설정** (1-2시간)
  - [ ] Sentry/Logflare 연동
  - [ ] Rate Limit 알림 설정
  - [ ] 대시보드 메트릭 추가

### 출시 후 권장 작업

- [ ] **사용량 모니터링** (첫 1개월)
  - [ ] 시간당 이메일 전송량 추적
  - [ ] 피크 시간대 파악
  - [ ] Rate Limit 에러 빈도 분석

- [ ] **사용자 피드백 수집**
  - [ ] Rate Limit 관련 불편 사항
  - [ ] 대량 가입 시나리오 테스트

- [ ] **확장 전략 수립**
  - [ ] 학원 10개 이상 시: Custom SMTP 고려
  - [ ] 학원 50개 이상 시: Email Service Provider 전환

## 긴급 대응 매뉴얼

### 상황 1: "이메일이 안 와요" 문의 급증

**진단**:
```bash
# Supabase Dashboard 확인
1. Authentication → Users → Filter by created_at (last 1 hour)
2. 30명 이상 가입자 확인
3. Email rate limit 도달 확인
```

**즉시 조치**:
1. 사용자에게 1-2시간 후 재시도 안내
2. 관리자 페이지에서 수동 이메일 재전송
3. Supabase Support에 일시적 limit 상향 요청

**장기 해결**:
1. Pro tier 업그레이드
2. Custom SMTP 설정 (SendGrid, AWS SES)

### 상황 2: 학원 WiFi에서 가입 불가

**진단**:
```bash
# 학원 네트워크 확인
1. Public IP 확인: https://api.ipify.org
2. 같은 IP로 동시 접속자 확인
```

**즉시 조치**:
1. 학생들에게 모바일 데이터 전환 안내
2. 5분 간격으로 분산 가입 권장

**장기 해결**:
1. Supabase IP별 제한 상향
2. 학원 네트워크 whitelist 추가 (Enterprise)

## 결론

**현재 상태**:
- Free tier 설정으로 소규모 테스트는 가능
- 프로덕션 배포 시 Rate Limit 문제 발생 가능성 **높음**

**권장 조치**:
1. **즉시**: 코드 레벨 Rate Limiting 구현 (이번 PR)
2. **출시 전**: Supabase Pro Tier 업그레이드 ($25/월)
3. **출시 후**: 사용량 모니터링 및 최적화

**비용 분석**:
```
학원 3개 운영 시 월 매출: $150-300
Supabase Pro 비용: $25/월
→ ROI: 500-1000%
```

**최종 추천**:
프로덕션 배포 전 **Supabase Pro Tier 업그레이드 필수**

---

**작성일**: 2025-10-15
**작성자**: Acadesk Team
**다음 리뷰**: 출시 1개월 후
