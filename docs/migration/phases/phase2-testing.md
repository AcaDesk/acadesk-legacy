# Phase 2: 테스트 및 검증 🧪

> **마이그레이션된 모든 기능에 대한 체계적 테스트**

## 📋 개요

**목표**: Phase 1, 3에서 마이그레이션된 모든 Server Actions의 기능, 권한, 에러 핸들링 검증
**예상 소요 시간**: 2-4시간
**우선순위**: **필수** (배포 전 반드시 완료)

## 🚀 환경 설정

### 1. 로컬 Supabase 인스턴스 시작

```bash
# Supabase 시작
supabase start

# 상태 확인
supabase status

# 환경변수 확인
pnpm env:validate
```

### 2. 필수 환경변수 확인

`.env.local` 파일에 다음 항목이 있는지 확인:

```bash
SUPABASE_SERVICE_ROLE_KEY=eyJ...  # service_role 키
NEXT_PUBLIC_SUPABASE_URL=http://localhost:54321
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJ...
```

### 3. 개발 서버 시작

```bash
pnpm dev
```

## ✅ 기능 테스트 체크리스트

### 1. TODO 템플릿 (Phase 1)

#### 생성 기능
- [ ] **필수 필드만으로 템플릿 생성**
  - 제목, 설명만 입력
  - 성공 시 템플릿 목록에 표시되는지 확인

- [ ] **모든 필드로 템플릿 생성**
  - 제목, 설명, 카테고리, 태그, 우선순위 등
  - 모든 필드가 정확히 저장되는지 확인

#### 수정 기능
- [ ] **템플릿 정보 수정**
  - 기존 템플릿 수정
  - 수정 내용이 즉시 반영되는지 확인

#### 활성화/비활성화
- [ ] **템플릿 활성화 토글**
  - active 상태 변경
  - 비활성화된 템플릿이 플래너에서 제외되는지 확인

#### 삭제 기능
- [ ] **템플릿 소프트 삭제**
  - 삭제 시 deleted_at 타임스탬프 설정
  - 목록에서 사라지는지 확인

#### 권한 테스트
- [ ] **staff 권한 없는 사용자 차단**
  - parent 또는 student 계정으로 접근
  - "권한이 없습니다" 에러 확인

---

### 2. 학생 관리 (Phase 1)

#### 생성 기능
- [ ] **보호자 신규 등록과 함께 학생 생성**
  - 보호자 정보 입력
  - users + guardians + students + student_guardians 모두 생성 확인

- [ ] **기존 보호자 선택하여 학생 생성**
  - 드롭다운에서 기존 보호자 선택
  - 관계만 추가되는지 확인

- [ ] **보호자 건너뛰기**
  - 보호자 없이 학생만 생성
  - 정상 등록 확인

#### 수정 기능
- [ ] **학생 정보 수정**
  - 이름, 학년, 연락처 등 변경
  - 변경 내용 저장 확인

#### 삭제 기능
- [ ] **학생 소프트 삭제**
  - deleted_at 설정
  - 목록에서 제거 확인

#### 중복 체크
- [ ] **중복 학생 코드 처리**
  - 동일한 student_code로 생성 시도
  - 적절한 에러 메시지 확인

---

### 3. TODO 플래너 (Phase 1)

#### 단일 추가
- [ ] **단일 학생에게 TODO 추가**
  - 한 명의 학생 선택
  - TODO 생성 확인

#### 일괄 추가 (템플릿)
- [ ] **여러 학생에게 템플릿으로 TODO 일괄 추가**
  - 템플릿 선택
  - 5명의 학생에게 동시 적용
  - 모든 학생에게 TODO 생성 확인

#### 일괄 추가 (수동)
- [ ] **여러 학생에게 수동 입력으로 TODO 일괄 추가**
  - 직접 제목, 설명 입력
  - 10명 이상 선택
  - 일괄 생성 확인

#### 주간 과제 게시
- [ ] **주간 과제 게시 (5명 이하)**
  - 응답 시간 측정
  - 예상: 2초 이내

- [ ] **주간 과제 게시 (20명 이상)**
  - 응답 시간 측정
  - 예상: 5초 이내

#### 계획 복사
- [ ] **이전 주차 계획 복사**
  - 복사 기능 실행
  - 모든 TODO가 새로운 주차로 복사되는지 확인

---

### 4. TODO 검증 (Phase 1)

#### 단일 검증
- [ ] **단일 TODO 검증**
  - 한 개의 TODO 선택
  - verified_at 타임스탬프 설정 확인

#### 일괄 검증
- [ ] **일괄 TODO 검증 (10개 이상)**
  - 여러 개 선택하여 검증
  - 모두 검증 상태로 변경 확인

#### 반려
- [ ] **TODO 반려 (피드백 포함)**
  - 반려 사유 입력
  - rejected_at, rejection_feedback 저장 확인

#### 에러 처리
- [ ] **완료되지 않은 TODO 검증 차단**
  - completed_at이 없는 TODO 검증 시도
  - "완료되지 않은 TODO는 검증할 수 없습니다" 에러 확인

- [ ] **이미 검증된 TODO 재검증 차단**
  - verified_at이 있는 TODO 검증 시도
  - "이미 검증된 TODO입니다" 에러 확인

---

### 5. 상담 기록 (Phase 3)

#### 생성 기능
- [ ] **상담 기록 생성**
  - 학생 선택
  - 상담 일자, 유형, 내용 입력
  - 저장 확인

#### 상담 유형
- [ ] **상담 유형 선택**
  - 대면, 전화, 화상, 기타 선택
  - 각 유형으로 저장 확인

#### 권한 검증
- [ ] **instructor 이상 권한 확인**
  - assistant 계정으로 접근 시도
  - 차단 확인

---

### 6. 출석 관리 (Phase 3)

#### 세션 생성
- [ ] **출석 세션 생성**
  - 클래스, 날짜, 시간 선택
  - 세션 생성 확인

#### 출석 체크
- [ ] **학생별 출석 체크**
  - 출석, 지각, 결석, 결석계 선택
  - check_in_at 타임스탬프 저장 확인

#### 일괄 저장
- [ ] **출석 일괄 저장**
  - 여러 학생의 출석 상태 입력
  - upsert로 저장 확인 (중복 방지)

#### 세션 삭제
- [ ] **출석 세션 삭제**
  - 세션과 출석 기록 모두 삭제
  - soft delete 확인

---

### 7. 성적 관리 (Phase 3)

#### 개별 입력
- [ ] **개별 성적 입력**
  - 한 학생의 성적 입력
  - 점수 자동 계산 (백분율) 확인

#### 일괄 입력
- [ ] **일괄 성적 입력 (클래스 단위)**
  - 30명 이상 일괄 입력
  - 응답 시간 측정 (목표: 2초 이내)

#### 점수 계산
- [ ] **점수 자동 계산 확인**
  - correct_answers / total_questions → percentage
  - 계산 정확도 확인

#### 삭제
- [ ] **성적 삭제**
  - soft delete 확인
  - 목록에서 제거 확인

---

### 8. 보호자 관리 (Phase 3)

#### 생성
- [ ] **보호자 생성 (users + guardians + student_guardians)**
  - 이름, 전화번호, 이메일, 관계 입력
  - 학생 연결 (1명)
  - 트랜잭션 성공 확인

- [ ] **보호자 생성 (여러 학생 연결)**
  - student_ids에 2명 이상 입력
  - 모든 학생과 연결 확인

#### 수정
- [ ] **보호자 정보 수정**
  - users + guardians 동시 업데이트
  - 변경 내용 저장 확인

#### 삭제
- [ ] **보호자 삭제 (Soft Delete)**
  - users.deleted_at, guardians.deleted_at 설정
  - 목록에서 제거 확인

---

## ⚡ 성능 테스트

### 대량 데이터 처리

| 작업 | 데이터 수 | 목표 시간 | 실제 시간 | 결과 |
|------|-----------|-----------|-----------|------|
| 대량 TODO 생성 | 100개 | < 5초 | ___ 초 | [ ] |
| 일괄 TODO 검증 | 50개 | < 3초 | ___ 초 | [ ] |
| 템플릿 목록 로딩 | 100개+ | < 1초 | ___ 초 | [ ] |
| 일괄 출석 저장 | 50명 | < 3초 | ___ 초 | [ ] |
| 일괄 성적 입력 | 30명 | < 2초 | ___ 초 | [ ] |

### 성능 측정 방법

```typescript
// 클라이언트 코드에서
console.time('bulkCreate')
await createTodosForStudents(data)
console.timeEnd('bulkCreate')
```

---

## 🛡️ 권한 테스트

### 권한별 접근 제어

| 기능 | owner | instructor | assistant | parent | student | 예상 결과 |
|------|-------|------------|-----------|--------|---------|----------|
| TODO 템플릿 생성 | ✅ | ✅ | ✅ | ❌ | ❌ | staff만 허용 |
| 학생 생성 | ✅ | ✅ | ✅ | ❌ | ❌ | staff만 허용 |
| TODO 검증 | ✅ | ✅ | ❌ | ❌ | ❌ | instructor+ |
| 상담 기록 | ✅ | ✅ | ❌ | ❌ | ❌ | instructor+ |
| 출석 관리 | ✅ | ✅ | ✅ | ❌ | ❌ | staff만 허용 |
| 성적 입력 | ✅ | ✅ | ✅ | ❌ | ❌ | staff만 허용 |
| 보호자 관리 | ✅ | ✅ | ✅ | ❌ | ❌ | staff만 허용 |

### 권한 테스트 수행 방법

1. **테스트 계정 준비**
   - owner 계정 1개
   - instructor 계정 1개
   - assistant 계정 1개
   - parent 계정 1개

2. **각 계정으로 로그인하여 기능 테스트**
   - 허용되어야 할 때: 정상 실행 확인
   - 차단되어야 할 때: "권한이 없습니다" 에러 확인

---

## 🚨 에러 핸들링 테스트

### 입력값 검증 (Zod)

- [ ] **잘못된 UUID 형식**
  - student_id에 "invalid-uuid" 입력
  - "유효한 학생 ID가 아닙니다" 에러 확인

- [ ] **필수 필드 누락**
  - 제목 없이 템플릿 생성 시도
  - "제목은 필수입니다" 에러 확인

- [ ] **이메일 형식 오류**
  - 잘못된 이메일 형식 입력
  - "유효한 이메일이 아닙니다" 에러 확인

### 존재하지 않는 리소스

- [ ] **존재하지 않는 학생 ID**
  - 삭제된 학생에게 TODO 추가 시도
  - "학생을 찾을 수 없습니다" 에러 확인

- [ ] **존재하지 않는 템플릿 ID**
  - 삭제된 템플릿 수정 시도
  - "템플릿을 찾을 수 없습니다" 에러 확인

### 중복 데이터

- [ ] **중복 학생 코드**
  - 동일한 student_code로 생성
  - "이미 존재하는 학생 코드입니다" 에러 확인

- [ ] **중복 이메일**
  - 동일한 이메일로 보호자 생성
  - "이미 사용 중인 이메일입니다" 에러 확인

### 네트워크 시나리오

- [ ] **네트워크 끊김**
  - 개발 도구에서 Offline 모드 활성화
  - 적절한 에러 메시지 확인

- [ ] **타임아웃**
  - 매우 큰 데이터 처리 (1000개+)
  - 타임아웃 에러 핸들링 확인

---

## 📊 테스트 결과 요약

### 전체 진행률

- **기능 테스트**: ___ / 50 완료 (___%)
- **성능 테스트**: ___ / 5 완료 (___%)
- **권한 테스트**: ___ / 7 완료 (___%)
- **에러 핸들링**: ___ / 10 완료 (___%)

### 발견된 이슈

| 이슈 | 심각도 | 상태 | 담당자 | 해결 날짜 |
|------|--------|------|--------|-----------|
| 예: TODO 검증 시 권한 체크 누락 | High | 해결 | Claude | 2025-10-23 |
| | | | | |
| | | | | |

### 다음 단계

- [ ] 모든 Critical 이슈 해결
- [ ] 성능 목표 미달 항목 최적화
- [ ] 테스트 결과 문서화
- [ ] Phase 4 (보안 강화) 진행 여부 결정

---

## 💡 Tips

### 빠른 테스트를 위한 최소 체크

시간이 부족할 경우 다음 3가지만 필수로 테스트:

1. **학생 생성** (보호자 신규)
2. **TODO 템플릿 생성**
3. **TODO 플래너 게시** (10명 이상)

### 자동화 고려

추후 다음 도구로 자동화 검토:
- Playwright E2E 테스트
- Vitest 통합 테스트
- Jest Unit 테스트

---

**작성일**: 2025-10-23
**다음 Phase**: [Phase 4 - 보안 강화](./phase4-security.md)
