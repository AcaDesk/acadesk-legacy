# í•™ìƒ ë°ì´í„° ì¬ì…ë ¥ - ì‹¤í–‰ ë°©ë²•

## âš ï¸ ì¤‘ìš”: ì˜¬ë°”ë¥¸ íŒŒì¼ ì‚¬ìš©

### âœ… ì‚¬ìš©í•  íŒŒì¼ (ìµœì‹ )
- **`cleanup-students-fixed.sql`** (3.3 KB)
- **`insert_students_final.sql`** (127 KB) â­

### âŒ ì‚¬ìš©í•˜ì§€ ë§ ê²ƒ (êµ¬ë²„ì „)
- ~~`insert_students_fixed.sql`~~ (96 KB) - ì˜¤ë˜ëœ ë²„ì „!
- ~~`insert_students_with_guardians.sql`~~ - ì˜¤ë˜ëœ ë²„ì „!

---

## ğŸ› í•´ê²°ëœ ëª¨ë“  ë¬¸ì œ

### 1. ì»¬ëŸ¼ëª… ì°¨ì´
- âŒ `phone_number` â†’ âœ… `phone`
- âŒ `relationship` â†’ âœ… `relation` (student_guardians í…Œì´ë¸”)

### 2. Primary ë³´í˜¸ì ì œì•½
- âŒ ëª¨ë“  ë³´í˜¸ì `is_primary = true` â†’ âœ… ì²« ë²ˆì§¸ë§Œ `true`
- âŒ `v_guardian_index` ì´ˆê¸°í™” ì•ˆë¨ â†’ âœ… ê° í•™ìƒë§ˆë‹¤ ì´ˆê¸°í™”

### 3. í•™ìƒ ì´ë¦„ "Unknown" ë¬¸ì œ
- âŒ `users` í…Œì´ë¸”ì— ë ˆì½”ë“œ ì—†ìŒ â†’ âœ… `users` í…Œì´ë¸”ì— í•™ìƒ/ë³´í˜¸ì ë ˆì½”ë“œ ìƒì„±
- ì• í”Œë¦¬ì¼€ì´ì…˜ì´ `student.users?.name`ìœ¼ë¡œ ì´ë¦„ì„ ê°€ì ¸ì˜´

---

## ğŸš€ ì‹¤í–‰ ìˆœì„œ

### 1ë‹¨ê³„: ë°±ì—…
Supabase Dashboard â†’ Settings â†’ Database â†’ Database backups â†’ **Create backup**

### 2ë‹¨ê³„: Cleanup ì‹¤í–‰

**Supabase SQL Editor:**

```sql
-- scripts/cleanup-students-fixed.sql íŒŒì¼ ë‚´ìš© ë³µì‚¬ í›„ ì‹¤í–‰
```

**ì˜ˆìƒ ì¶œë ¥:**
```
NOTICE: Starting cleanup for tenant: cf5ba30f-4081-494f-952f-45a7264a0c5d
NOTICE: Students to delete: 53
NOTICE: Guardians to delete: 42
NOTICE: Student users to delete: 53
NOTICE: Guardian users to delete: 42
NOTICE: âœ“ Deleted student-guardian relationships
NOTICE: âœ“ Deleted class enrollments
NOTICE: âœ“ Deleted exam scores
NOTICE: âœ“ Deleted student todos
NOTICE: âœ“ Deleted attendance records
NOTICE: âœ“ Deleted 53 students
NOTICE: âœ“ Deleted 42 guardians
NOTICE: âœ“ Deleted 53 student users
NOTICE: âœ“ Deleted 42 guardian users
NOTICE: ğŸ‰ Cleanup completed successfully
```

### 3ë‹¨ê³„: Insert ì‹¤í–‰

**Supabase SQL Editor:**

```sql
-- scripts/insert_students_final.sql íŒŒì¼ ë‚´ìš© ë³µì‚¬ í›„ ì‹¤í–‰
```

**ì˜ˆìƒ ì¶œë ¥:**
```
NOTICE: Starting student and guardian insertion...
NOTICE: Total students to insert: 53
  â†’ Created new guardian with phone: +821075425617
NOTICE: âœ… Successfully inserted student 1/53 : ë°•ê·œë¹ˆ
  â†’ Created new guardian with phone: +821085714200
NOTICE: âœ… Successfully inserted student 2/53 : ë°•ë‹¤ë¹ˆ
...
  â†’ Created new guardian with phone: +821024843711
  â†’ Created new guardian with phone: +821064623189
NOTICE: âœ… Successfully inserted student 16/53 : ë°•ì´ì•ˆ
...
NOTICE: ğŸ‰ All 53 students inserted successfully!
```

---

## âœ… ê²€ì¦

### 1. í•™ìƒ ìˆ˜
```sql
SELECT COUNT(*) FROM students
WHERE tenant_id = 'cf5ba30f-4081-494f-952f-45a7264a0c5d'
  AND deleted_at IS NULL;
-- ì˜ˆìƒ: 53ëª…
```

### 2. í•™ìƒ ì´ë¦„ í™•ì¸ (Unknown ì•„ë‹˜!)
```sql
SELECT
  s.student_code,
  s.name as student_table_name,
  u.name as user_table_name,
  CASE WHEN u.name IS NULL THEN 'âŒ NULL' ELSE 'âœ… OK' END as status
FROM students s
LEFT JOIN users u ON s.user_id = u.id
WHERE s.tenant_id = 'cf5ba30f-4081-494f-952f-45a7264a0c5d'
  AND s.deleted_at IS NULL
ORDER BY s.student_code;
-- ëª¨ë“  user_table_nameì´ 'âœ… OK'ì—¬ì•¼ í•¨
```

### 3. Primary ë³´í˜¸ì í™•ì¸
```sql
SELECT
  s.student_code,
  s.name,
  COUNT(CASE WHEN sg.is_primary THEN 1 END) as primary_count
FROM students s
LEFT JOIN student_guardians sg ON s.id = sg.student_id
WHERE s.tenant_id = 'cf5ba30f-4081-494f-952f-45a7264a0c5d'
  AND s.deleted_at IS NULL
GROUP BY s.id, s.student_code, s.name
HAVING COUNT(CASE WHEN sg.is_primary THEN 1 END) != 1;
-- ì˜ˆìƒ: ê²°ê³¼ ì—†ìŒ
```

---

## ğŸ“Š ìƒì„±ë˜ëŠ” ë°ì´í„°

- âœ… **53ëª…** í•™ìƒ (students í…Œì´ë¸”)
- âœ… **53ëª…** í•™ìƒ ì‚¬ìš©ì (users í…Œì´ë¸”, role_code='student')
- âœ… **ì•½ 42ëª…** ë³´í˜¸ì (guardians í…Œì´ë¸”)
- âœ… **ì•½ 42ëª…** ë³´í˜¸ì ì‚¬ìš©ì (users í…Œì´ë¸”, role_code='parent')
- âœ… **ì•½ 55ê°œ** í•™ìƒ-ë³´í˜¸ì ê´€ê³„
- âœ… í‚¤ì˜¤ìŠ¤í¬ PIN: **1234** (ëª¨ë“  í•™ìƒ)

---

## ğŸ”§ í•µì‹¬ ê°œì„ ì‚¬í•­

### v6 (ìµœì‹ ) vs êµ¬ë²„ì „

| í•­ëª© | êµ¬ë²„ì „ | v6 (ìµœì‹ ) |
|------|--------|----------|
| users í…Œì´ë¸” | âŒ ìƒì„± ì•ˆí•¨ | âœ… í•™ìƒ/ë³´í˜¸ì ë ˆì½”ë“œ ìƒì„± |
| students.user_id | âŒ NULL | âœ… users.id ë§í¬ |
| guardians.user_id | âŒ NULL | âœ… users.id ë§í¬ |
| í•™ìƒ ì´ë¦„ í‘œì‹œ | âŒ "Unknown" | âœ… ì •ìƒ í‘œì‹œ |
| Primary ë³´í˜¸ì | âŒ ì—ëŸ¬ ë°œìƒ | âœ… ì²« ë²ˆì§¸ë§Œ primary |

---

**ì‘ì„±ì¼**: 2025-11-01
**ë²„ì „**: v6 (With Users)
**íŒŒì¼**: `insert_students_final.sql` (127 KB)
**ìƒíƒœ**: âœ… í”„ë¡œë•ì…˜ ì ìš© ì¤€ë¹„ ì™„ë£Œ
